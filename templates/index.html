<!-- templates/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Conversations</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // When the page loads, wire up the search form and modal
    document.addEventListener("DOMContentLoaded", () => {
      const searchForm = document.getElementById("search-form");
      const queryInput = document.getElementById("search-query");
      const thresholdSlider = document.getElementById("accuracy-slider");
      const thresholdValue = document.getElementById("accuracy-value");
      const resultsModal = document.getElementById("results-modal");
      const resultsContainer = document.getElementById("results-container");
      const modalCloseBtn = document.getElementById("modal-close");

      // Show slider value in real time
      thresholdSlider.addEventListener("input", () => {
        thresholdValue.textContent = parseFloat(thresholdSlider.value).toFixed(2);
      });

      // On form submit, prevent default, do AJAX fetch
      searchForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const q = queryInput.value.trim();
        const threshold = parseFloat(thresholdSlider.value);

        if (!q) {
          return;
        }

        // Clear previous results
        resultsContainer.innerHTML = `
          <p class="text-gray-600">Loading results‚Ä¶</p>
        `;
        // Show modal
        resultsModal.classList.remove("hidden");

        try {
          const resp = await fetch(`/search?q=${encodeURIComponent(q)}&threshold=${threshold}`);
          const data = await resp.json();

          if (!data || data.length === 0) {
            resultsContainer.innerHTML = `
              <p class="text-gray-600">No matching conversations found (threshold ‚â• ${thresholdValue.textContent}).</p>
            `;
            return;
          }

          // Build result items
          const items = data.map(item => {
            return `
              <a href="/conversations/${item.conv_id}" class="block p-4 mb-2 bg-white rounded-lg shadow hover:bg-blue-50 transition">
                <div class="flex justify-between items-center">
                  <span class="font-semibold">Conversation #${item.conv_id}</span>
                  <span class="text-sm text-gray-500">sim: ${ (item.similarity * 100).toFixed(1) }%</span>
                </div>
                <div class="text-xs text-gray-600 mt-1">
                  <span><strong>Started:</strong> ${item.start_time}</span>
                </div>
                <p class="mt-2 text-sm text-gray-700">${item.snippet}</p>
              </a>
            `;
          }).join("");

          resultsContainer.innerHTML = items;
        } catch (err) {
          console.error(err);
          resultsContainer.innerHTML = `
            <p class="text-red-600">Error performing search. Please try again.</p>
          `;
        }
      });

      // Close modal on clicking ‚Äú√ó‚Äù
      modalCloseBtn.addEventListener("click", () => {
        resultsModal.classList.add("hidden");
      });
      // Also close if clicking outside modal content
      resultsModal.addEventListener("click", (e) => {
        if (e.target === resultsModal) {
          resultsModal.classList.add("hidden");
        }
      });
    });
  </script>
</head>

<body class="bg-gray-100 text-gray-800">
  <!-- NAVBAR -->
  <nav class="bg-white shadow">
    <div class="max-w-3xl mx-auto px-4">
      <div class="flex justify-between items-center h-16">
        <!-- Brand / Home Link -->
        <a href="{{ url_for('index') }}" class="text-xl font-bold text-gray-800 hover:text-blue-600">
          üó®Ô∏è Conversations
        </a>
        <!-- Settings Link -->
        <a href="{{ url_for('settings') }}" class="text-gray-600 hover:text-blue-600">
          ‚öôÔ∏è Settings
        </a>
      </div>
    </div>
  </nav>

  <div class="max-w-3xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6">All Conversations</h1>

    <!-- SEARCH BOX + ACCURACY SLIDER -->
    <form id="search-form" class="mb-6 flex flex-col sm:flex-row sm:items-center sm:space-x-4">
      <input
        type="text"
        id="search-query"
        placeholder="Search conversations‚Ä¶"
        class="flex-grow px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
      />
      <div class="mt-2 sm:mt-0 flex items-center space-x-2">
        <label for="accuracy-slider" class="text-sm font-medium">Accuracy:</label>
        <input
          type="range"
          id="accuracy-slider"
          min="0.00"
          max="1.00"
          step="0.01"
          value="0.10"
          class="h-2"
        />
        <span id="accuracy-value" class="text-sm w-12 text-center">0.10</span>
      </div>
      <button
        type="submit"
        class="mt-2 sm:mt-0 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
      >
        Search
      </button>
    </form>

    {% if conversations %}
      <ul>
        {% for conv in conversations %}
          <li class="mb-4">
            <a
              href="{{ url_for('view_conversation', conv_id=conv['id']) }}"
              class="block p-4 bg-white rounded-xl shadow hover:bg-blue-50 transition"
            >
              <div>
                <span class="text-xl font-semibold">Conversation #{{ conv['id'] }}</span>
                <span class="text-gray-600 ml-2">started {{ conv['start_time'] }}</span>
              </div>
              <div class="mt-1 text-sm text-gray-500">
                <span class="mr-4"><strong>LLM:</strong> {{ conv['llm_model'] }}</span>
                <span><strong>TTS:</strong> {{ conv['tts_voice'] }}</span>
              </div>
              {# Only show actual summary_short, never literal ‚ÄúBrief Summary‚Äù #}
              {% if conv['summary_short'] %}
                <p class="mt-2 text-sm text-gray-700 italic">{{ conv['summary_short'] }}</p>
              {% endif %}
            </a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-gray-600">No conversations found.</p>
    {% endif %}
  </div>

  <!-- MODAL FOR SEARCH RESULTS -->
  <div
    id="results-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
  >
    <div class="bg-white w-11/12 md:w-2/3 lg:w-1/2 rounded-xl shadow-lg overflow-hidden">
      <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-semibold">Search Results</h2>
        <button id="modal-close" class="text-gray-600 hover:text-gray-800">&times;</button>
      </div>
      <div id="results-container" class="p-4 max-h-96 overflow-y-auto">
        <!-- Results will be injected here -->
      </div>
    </div>
  </div>
</body>
</html>
